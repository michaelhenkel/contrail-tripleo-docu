<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Backing up and Restoring your Undercloud &mdash; tripleo-docs 0.0.1.dev17 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1.dev17',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/cookies.js"></script>
    <script type="text/javascript" src="../_static/expandable.js"></script>
    <script type="text/javascript" src="../_static/admonition_selector.js"></script>
    <script type="text/javascript" src="../_static/jquery.scrollTo.js"></script>
    <script type="text/javascript" src="../_static/jquery.nav.js"></script>
    <script type="text/javascript" src="../_static/menu.js"></script>
    <link rel="top" title="tripleo-docs 0.0.1.dev17 documentation" href="../index.html" />
    <link rel="up" title="Post Deployment" href="post_deployment.html" />
    <link rel="next" title="Troubleshooting" href="../troubleshooting/troubleshooting.html" />
    <link rel="prev" title="Updating Packages on Overcloud Nodes" href="package_update.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="backing-up-and-restoring-your-undercloud">
<h1>Backing up and Restoring your Undercloud<a class="headerlink" href="#backing-up-and-restoring-your-undercloud" title="Permalink to this headline">¶</a></h1>
<div class="section" id="backing-up-your-undercloud">
<h2>Backing up your Undercloud<a class="headerlink" href="#backing-up-your-undercloud" title="Permalink to this headline">¶</a></h2>
<p>In order to backup your undercloud you need to make sure the following items are backed up</p>
<ul class="simple">
<li>All MariaDB databases on the undercloud node</li>
<li>MariaDB configuration file on undercloud (so we can restore databases accurately)</li>
<li>All glance image data in /var/lib/glance/images</li>
<li>All swift data in /srv/node</li>
<li>All data in stack users home directory</li>
</ul>
<p>The following commands can be used to perform a backup of all data from the undercloud node:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mysqldump --opt --all-databases &gt; /root/undercloud-all-databases.sql
tar -czf undercloud-backup-`date +%F`.tar.gz undercloud-all-databases.sql /etc/my.cnf.d/server.cnf /var/lib/glance/images /srv/node /home/stack /etc/pki /opt/stack
</pre></div>
</div>
</div>
<div class="section" id="restoring-a-backup-of-your-undercloud-on-a-fresh-machine">
<h2>Restoring a backup of your Undercloud on a Fresh Machine<a class="headerlink" href="#restoring-a-backup-of-your-undercloud-on-a-fresh-machine" title="Permalink to this headline">¶</a></h2>
<p>The following restore process assumes you are recovering from a failed undercloud node where you have to reinstall it from scratch.
It assumes that the hardware layout is the same, and the hostname and undercloud settings of the machine will be the same as well.
Once the machine is installed and is in a clean state, re-enable all the subscriptions/repositories needed to install and run TripleO.</p>
<p>Note that unless specified, all commands are run as root.</p>
<p>Then install mariadb server with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>yum install -y mariadb-server
</pre></div>
</div>
<p>Now restore the MariaDB configuration file and database backup, then start the MariaDB server and load the backup in:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tar -xzC / -f undercloud-backup-$DATE.tar.gz etc/my.cnf.d/server.cnf /root/undercloud-all-databases.sql
# Edit /etc/my.cnf.d/server.cnf and comment out &#39;bind-address&#39;
systemctl start mariadb
cat /root/undercloud-all-databases.sql | mysql
# Now we need to clean out some old permissions to be recreated
for i in ceilometer glance heat ironic keystone neutron nova;do mysql -e &quot;drop user $i&quot;;done
mysql -e &#39;flush privileges&#39;
</pre></div>
</div>
<p>Now create the stack user and restore the stack users home directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>sudo useradd stack
sudo passwd stack  # specify a password

echo &quot;stack ALL=(root) NOPASSWD:ALL&quot; | sudo tee -a /etc/sudoers.d/stack
sudo chmod 0440 /etc/sudoers.d/stack
</pre></div>
</div>
<p>Next restore the stack users home directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tar -xzC / -f undercloud-backup-$DATE.tar.gz home/stack
</pre></div>
</div>
<p>We have to now install the swift and glance base packages, and then restore their data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>yum install -y openstack-glance openstack-swift
tar -xzC / -f undercloud-backup-$DATE.tar.gz srv/node var/lib/glance/images
# Confirm data is owned by correct user
chown -R swift: /srv/node
chown -R glance: /var/lib/glance/images
</pre></div>
</div>
<p>Finally we rerun the undercloud installation from the stack user, making sure to run it in the stack user home dir:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>su - stack
sudo yum install -y python-tripleoclient
# Double check hostname is correctly set in /etc/hosts
openstack install undercloud
</pre></div>
</div>
</div>
<div class="section" id="reconnect-the-restored-undercloud-to-the-overcloud">
<h2>Reconnect the restored undercloud to the overcloud<a class="headerlink" href="#reconnect-the-restored-undercloud-to-the-overcloud" title="Permalink to this headline">¶</a></h2>
<p>Having completed the steps above, the undercloud can be expected to automatically
restore its connection to the overcloud. The nodes will continue to poll
Orchestration (heat) for pending tasks, using a simple HTTP request issued every
few seconds.</p>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Table Of Contents</h3>
            <ul><li><a href="../index.html">Return to project home page</a></li></ul>
            <ul>
<li><a class="reference internal" href="#">Backing up and Restoring your Undercloud</a><ul>
<li><a class="reference internal" href="#backing-up-your-undercloud">Backing up your Undercloud</a></li>
<li><a class="reference internal" href="#restoring-a-backup-of-your-undercloud-on-a-fresh-machine">Restoring a backup of your Undercloud on a Fresh Machine</a></li>
<li><a class="reference internal" href="#reconnect-the-restored-undercloud-to-the-overcloud">Reconnect the restored undercloud to the overcloud</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="package_update.html"
                                  title="previous chapter">Updating Packages on Overcloud Nodes</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="../troubleshooting/troubleshooting.html"
                                  title="next chapter">Troubleshooting</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/michaelhenkel/contrail-tripleo-docu
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/post_deployment/backup_restore_undercloud.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
  <div id="admonition_selector">
    <span class="trigger">Limit Environment Specific Content</span>

    <div class="content">
      <span class="title">Operating Systems</span>
      <ul>
        <li><input type="checkbox" id="centos" checked="checked"><label for="centos" title="Step that should only be run when using CentOS.">CentOS</label></li>
        <li><input type="checkbox" id="rhel" checked="checked"><label for="rhel" title="Step that should only be run when using RHEL.">RHEL</label></li>
      </ul>

      <span class="title">RHEL Registration Types</span>
      <ul>
        <li><input type="checkbox" id="portal" checked="checked"><label for="portal" title="Step that should only be run when registering to the Red Hat Portal.">Portal</label></li>
        <li><input type="checkbox" id="satellite" checked="checked"><label for="satellite" title="Step that should only be run when registering to Red Hat Satellite.">Satellite</label></li>
      </ul>

      <span class="title">Environments</span>
      <ul>
        <li><input type="checkbox" id="baremetal" checked="checked"><label for="baremetal" title="Step that should only be run when deploying to baremetal.">Baremetal</label></li>
        <li><input type="checkbox" id="virtual" checked="checked"><label for="virtual" title="Step that should only be run when deploying to virtual machines.">Virtual</label></li>
        <li><input type="checkbox" id="ssl" checked="checked"><label for="ssl" title="Step that should only be run when deploying with SSL OpenStack endpoints.">SSL</label></li>
        <li><input type="checkbox" id="selfsigned" checked="checked"><label for="selfsigned" title="Step that should only be run when deploying with SSL and a self-signed certificate.">Self-Signed SSL</label></li>
      </ul>

      <span class="title">Additional Overcloud Roles</span>
      <ul>
        <li><input type="checkbox" id="ceph" checked="checked"><label for="ceph" title="Step that should only be run when deploying Ceph for use by the Overcloud.">Ceph</label></li>
      </ul>

      <span class="title">Development options</span>
      <ul>
         <li><input type="checkbox" id="source" checked=""><label for="source"
            title="Step that should only be run when choosing to use some components directly from their git source code repositories instead of packages.">Install from source</label></li>
        <li><input type="checkbox" id="stable" checked=""><label for="stable"
            title="Step that should only be run when choosing to use components from their stable branches rather than using packages/source based on current master.">Install from stable branch</label></li>
      </ul>


    </div>
  </div>

  
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>

    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../troubleshooting/troubleshooting.html" title="Troubleshooting"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="package_update.html" title="Updating Packages on Overcloud Nodes"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">tripleo-docs 0.0.1.dev17 documentation</a> &raquo;</li>
          <li><a href="post_deployment.html" accesskey="U">Post Deployment</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2015, OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/tripleo-docs");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>