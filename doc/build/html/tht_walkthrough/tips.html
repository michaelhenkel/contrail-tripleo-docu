<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Deployment tips for puppet-tripleo &mdash; tripleo-docs 0.0.1.dev17 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1.dev17',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/cookies.js"></script>
    <script type="text/javascript" src="../_static/expandable.js"></script>
    <script type="text/javascript" src="../_static/admonition_selector.js"></script>
    <script type="text/javascript" src="../_static/jquery.scrollTo.js"></script>
    <script type="text/javascript" src="../_static/jquery.nav.js"></script>
    <script type="text/javascript" src="../_static/menu.js"></script>
    <link rel="top" title="tripleo-docs 0.0.1.dev17 documentation" href="../index.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="deployment-tips-for-puppet-tripleo">
<h1>Deployment tips for puppet-tripleo<a class="headerlink" href="#deployment-tips-for-puppet-tripleo" title="Permalink to this headline">¶</a></h1>
<p>This section will describe different ways of debugging puppet-tripleo changes.</p>
<div class="section" id="deploying-puppet-tripleo-using-gerrit-patches-or-source-code-repositories">
<h2>Deploying puppet-tripleo using gerrit patches or source code repositories<a class="headerlink" href="#deploying-puppet-tripleo-using-gerrit-patches-or-source-code-repositories" title="Permalink to this headline">¶</a></h2>
<p>When adding new features to THT, in some cases dependencies should be merged
first in order to test newer patches, with the following procedure, the user
will be able to create the overcloud images using WorkInProgress patches from
gerrit code review without having them merged (for CI testing purposes).</p>
<p>If using third party repos included in the overcloud image, like i.e. the
puppet-tripleo repository, your changes will not be available by default in the
overcloud until you write them in the overcloud image (by default is:
overcloud-full.qcow2)</p>
<p>In order to make quick changes to the overcloud image for testing purposes, you
can:</p>
<p>Create the overcloud image by following (<tt class="xref doc docutils literal"><span class="pre">in_progress_review</span></tt>) :</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>export DIB_INSTALLTYPE_puppet_tripleo=source

export DIB_REPOLOCATION_puppet_tripleo=https://review.openstack.org/openstack/puppet-tripleo

export DIB_REPOREF_puppet_tripleo=refs/changes/25/310725/14
</pre></div>
</div>
<p>In order to avoid noise on IRC, it is possible to clone puppet-tripleo and
apply the changes from your github account. In some cases this is particularly
useful as there is no need to update the patchset number.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>export DIB_INSTALLTYPE_puppet_tripleo=source

export DIB_REPOLOCATION_puppet_tripleo=https://github.com/&lt;usergoeshere&gt;/puppet-tripleo
</pre></div>
</div>
<p>Remove previously created images from glance and from the user home folder by:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>rm -rf overcloud-full.*

glance image-delete overcloud-full

glance image-delete overcloud-full-initrd

glance image-delete overcloud-full-vmlinuz
</pre></div>
</div>
<p>After this step the images can be recreated by executing:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>./tripleo-ci/scripts/tripleo.sh --overcloud-images
</pre></div>
</div>
</div>
<div class="section" id="pushing-changes-directly-without-re-creating-the-overcloud-images">
<h2>Pushing changes directly without re-creating the overcloud images<a class="headerlink" href="#pushing-changes-directly-without-re-creating-the-overcloud-images" title="Permalink to this headline">¶</a></h2>
<p>On the undercloud as the stack user, clone the openstack modules using:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>#!/bin/bash
set -eu
cd ~
if [ ! -e ~/puppet-modules ]; then
  mkdir ~/puppet-modules
  pushd ~/puppet-modules
    curl -O https://raw.githubusercontent.com/openstack/tripleo-puppet-elements/master/elements/puppet-modules/source-repository-puppet-modules
    mapfile -t REPO_CLONES &lt; &lt;(cat source-repository-puppet-modules | awk &#39;{ print $4 &quot; &quot; $3 }&#39; | sed -e &#39;s|/opt/stack/puppet-modules/||&#39;)
    for CLONE in &quot;${REPO_CLONES[@]}&quot;; do
      git clone $CLONE
    done
  popd
fi
</pre></div>
</div>
<p>Then, using the following script, upload the cloned puppet modules to swift</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>#!/bin/bash
set -eu
cd ~
tar --exclude-vcs --show-transformed-names --transform &#39;s|puppet-modules/|opt/stack/puppet-modules/|&#39; -czvf puppet-modules.tar.gz puppet-modules
upload-swift-artifacts -f puppet-modules.tar.gz --environment puppet-modules.yaml
</pre></div>
</div>
<p>This will generates the puppet-modules.yaml environment file, which can be
added to the deployment command (&#8220;-e puppet-modules.yaml&#8221;) and use cloned
puppet modules</p>
<p>After every manual change to any of the puppet modules it is possible to re-run
the upload to swift, and re-run <cite>overcloud deploy</cite> with the new env file. This
process will speed up the changes in the ovecloud images.</p>
</div>
<div class="section" id="debugging-puppet-tripleo-from-overcloud-images">
<h2>Debugging puppet-tripleo from overcloud images<a class="headerlink" href="#debugging-puppet-tripleo-from-overcloud-images" title="Permalink to this headline">¶</a></h2>
<p>For debugging purposes, it is possible to mount the overcloud .qcow2 file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>#Install the libguest tool:
sudo yum install -y libguestfs-tools

#Create a temp folder to mount the overcloud-full image:
mkdir /tmp/overcloud-full

#Mount the image:
guestmount -a overcloud-full.qcow2 -i --rw /tmp/overcloud-full

#Check and validate all the changes to your overcloud image, go to /tmp/overcloud-full:
#  For example, in this step you can go to /opt/puppet-modules/tripleo,

#Umount the image
sudo umount /tmp/overcloud-full
</pre></div>
</div>
<p>From the mounted image file it is also possible to run, for testing purposes,
the puppet manifests by using <tt class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span></tt> and including your manifests:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>sudo puppet apply -v --debug --modulepath=/tmp/overcloud-full/opt/stack/puppet-modules -e &quot;include ::tripleo::services::time::ntp&quot;
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Table Of Contents</h3>
            <ul><li><a href="../index.html">Return to project home page</a></li></ul>
            <ul>
<li><a class="reference internal" href="#">Deployment tips for puppet-tripleo</a><ul>
<li><a class="reference internal" href="#deploying-puppet-tripleo-using-gerrit-patches-or-source-code-repositories">Deploying puppet-tripleo using gerrit patches or source code repositories</a></li>
<li><a class="reference internal" href="#pushing-changes-directly-without-re-creating-the-overcloud-images">Pushing changes directly without re-creating the overcloud images</a></li>
<li><a class="reference internal" href="#debugging-puppet-tripleo-from-overcloud-images">Debugging puppet-tripleo from overcloud images</a></li>
</ul>
</li>
</ul>

            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/michaelhenkel/contrail-tripleo-docu
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/tht_walkthrough/tips.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
  <div id="admonition_selector">
    <span class="trigger">Limit Environment Specific Content</span>

    <div class="content">
      <span class="title">Operating Systems</span>
      <ul>
        <li><input type="checkbox" id="centos" checked="checked"><label for="centos" title="Step that should only be run when using CentOS.">CentOS</label></li>
        <li><input type="checkbox" id="rhel" checked="checked"><label for="rhel" title="Step that should only be run when using RHEL.">RHEL</label></li>
      </ul>

      <span class="title">RHEL Registration Types</span>
      <ul>
        <li><input type="checkbox" id="portal" checked="checked"><label for="portal" title="Step that should only be run when registering to the Red Hat Portal.">Portal</label></li>
        <li><input type="checkbox" id="satellite" checked="checked"><label for="satellite" title="Step that should only be run when registering to Red Hat Satellite.">Satellite</label></li>
      </ul>

      <span class="title">Environments</span>
      <ul>
        <li><input type="checkbox" id="baremetal" checked="checked"><label for="baremetal" title="Step that should only be run when deploying to baremetal.">Baremetal</label></li>
        <li><input type="checkbox" id="virtual" checked="checked"><label for="virtual" title="Step that should only be run when deploying to virtual machines.">Virtual</label></li>
        <li><input type="checkbox" id="ssl" checked="checked"><label for="ssl" title="Step that should only be run when deploying with SSL OpenStack endpoints.">SSL</label></li>
        <li><input type="checkbox" id="selfsigned" checked="checked"><label for="selfsigned" title="Step that should only be run when deploying with SSL and a self-signed certificate.">Self-Signed SSL</label></li>
      </ul>

      <span class="title">Additional Overcloud Roles</span>
      <ul>
        <li><input type="checkbox" id="ceph" checked="checked"><label for="ceph" title="Step that should only be run when deploying Ceph for use by the Overcloud.">Ceph</label></li>
      </ul>

      <span class="title">Development options</span>
      <ul>
         <li><input type="checkbox" id="source" checked=""><label for="source"
            title="Step that should only be run when choosing to use some components directly from their git source code repositories instead of packages.">Install from source</label></li>
        <li><input type="checkbox" id="stable" checked=""><label for="stable"
            title="Step that should only be run when choosing to use components from their stable branches rather than using packages/source based on current master.">Install from stable branch</label></li>
      </ul>


    </div>
  </div>

  
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>

    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">tripleo-docs 0.0.1.dev17 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2015, OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/tripleo-docs");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>